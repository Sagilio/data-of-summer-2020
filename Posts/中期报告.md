# 中期报告

## 项目信息

- 项目名称：Casbin.NET 生态完善
- 方案描述：
  Casbin.NET是Casbin的Dotnet版实现，目前仅完成核心功能，需要对项目进行进一步的优化和完善。目前计划提供一个完成核心能力开箱即用的服务化(RESTful)的解决方案(Casbin.SamNet)，并且适配Steeltoe。
- 时间规划：2020.7.1 - 2020.9.30

## 项目进度

- 已完成工作：
  1. 建立Casbin.AspNetCore项目并实现了大部分所需功能，本项目将是casbin-san项目的重要依赖。
  2. 对Casbin.NET进行了持续的优化，主要包含以下工作：
       - 优化了在大量策略时是的加载性能
       - 增加了异步支持
       - 增加 KeyMatch4 的函数支持
       - 增加 Benchmark 项目并在 CI 中自动执行以监测性能变化
       - 解决了过程中所有用户提交的 issue
  3. 实现casbin-sam的整体和Management的项目设计，对Management项目进行了基本实现
  4. 总计代码(贡献)量：
       - Casbin.Sam: **5 commits** = **2,228 ++ (包含自动生成)** - **1,248 ++ (不含自动生成)** - **21 --**
       - Casbin.NET: **30 commits** = **5,915 ++ (不含自动生成)** - **3,154 --**
       - Casbin.AspNetCore: **27 commit** = **44,349 ++ (包含自动生成)** - **3,462 ++ (不含自动生成)** - **1,761 --**
       - EFCore-Adapter: **7 commits** = **182 ++ (不含自动生成)** - **72 --**
       - 总计: **69 commits** = **52,674 ++ (包含自动生成)** - **10,807 ++ (不包含自动生成)** - **5008 --**
  5. 更多具体贡献详见[周报](https://isrc.iscas.ac.cn/gitlab/summer2020/students/proj-2008311/-/blob/master/%E4%B8%AD%E6%9C%9F%E6%8A%A5%E5%91%8A/%E5%91%A8%E6%8A%A5%20(%E8%87%B3%E7%AC%AC%E5%85%AD%E5%91%A8).md)


- 遇到的问题及解决方案：
  1. 大量策略的性能优化

     Casbin在策略加载时需要保证策略的唯一性，因此这讲对策略集合数据结构的查找性能提出较高要求，同时在鉴权时还需要保证策略的顺序。项目在之前的实现中使用的简单的顺序表的实现，为了优化其查找的性能，便增加了一个HashSet的集合来存储现有策略的状态。更多的信息可以在 [Pull Requset #39](https://github.com/casbin/Casbin.NET/pull/39) 查看，但是这实际造成了内存的过多消耗，正在考虑用其他方式比如Memory<char>切片来实现更尤的占用，同时还将提高计算时的性能。

  2. Casbin.AspNetCore的适配设计
     
     本项目主要难点在于“适配”方面。也就是需要保证原来的鉴权方案与新的方案可以共存，并保留原有的鉴权方式类似的使用体验，同时也需要保证设计的可扩展性。过程中，RequestTransformer及其授权上下文的生成是设计的重点，RequestTransformer主要作为实际授权上下文与Casbin所需参数的结合的重要枢纽，这也对之后的灵活补充提供了保证，casbin-sam的attributes的实现将是在此基础上的扩展。

  3. casbin-sam的基础设计
     
     本设计要解决的问题有部分和Casbin.AspNetCore是重合的。在其余的设计上关注点主要在于管理方式的和策略同步方式的设计。本方案的服务是作为全部应用策略的最高Leader或者说Master的角色，与同社区其他几位同学研究的基于Raft对分布式的实现中的被选举出Leader所不同的是，本服务的状态本来就需要针对不同应用体现出的特有的隔离数据集，同时提供更专注单向的数据同步方式，其作用应作为在整个服务体系中应作为最核心的管理。当然本方案还可以满足如项目计划里所描述的更多的场景，本次计划是对其作基础功能上的实现，更多功能上的完善和有些更有挑战性的难题，例如策略集合达到过大的数量级时的管理则是本次活动后更未来的工作。


- 后续工作安排：
  
  在前半个阶段更多的代码贡献都在Casbin.NET和Casbin.AspNetCore两个库上，相对于一开始的将三者的工作分布的更加均匀的计划书中的设计有所不同，并且设计类的工作比预计时间花费的更长，因此在后续工作中将把全部精力放在casbin-sam的实现上。